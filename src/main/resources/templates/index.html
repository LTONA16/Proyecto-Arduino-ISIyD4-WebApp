<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Carga el archivo de estilos Tailwind para el diseño atractivo y responsivo -->
    <link th:href="@{/styles/output.css}" rel="stylesheet" />
    <link rel="stylesheet" href="https://kit.fontawesome.com/ec46b80c81.css" crossorigin="anonymous" />

    <!-- Carga la fuente de texto -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
            href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Quicksand:wght@300..700&display=swap"
            rel="stylesheet" />

    <!-- Carga Chart.js para graficar los datos de humedad y temperatura en tiempo real -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <meta charset="UTF-8" />
    <title>Monitoreo en Tiempo Real</title>
</head>

<!-- Agregamos padding al body y declaramos la fuente del texto -->

<body class="bg-bkg-primary text-white h-fit" style="font-family: Poppins">
<!-- Contenedor principal de la página con diseño centrado -->
<div class="items-center h-full">
    <div class="items-center h-full">
        <header class="p-6 flex space-x-2 items-center w-full justify-between bg-bkg-mid">
            <div class="flex items-center space-x-2">
                <i class="fa-solid fa-cloud text-xl"></i>
                <p style="font-family: Quicksand" class="font-semibold text-xl">
                    SensorISI
                </p>
            </div>
            <div class="flex space-x-4">
                <a th:href="@{/}" class="underline underline-offset-8">Inicio</a>
                <a th:href="@{/humedad/}">Humedad</a>
                <a th:href="@{/temperatura/}">Temperatura</a>
            </div>
        </header>

        <!-- Banner -->
        <div class="bg-bkg-light p-4 mt-6 mb-0 mx-6 rounded-xl justify-between border-l-4 border-bkg-red flex"
             id="banner">
            <div class="flex items-center space-x-4">
                <i class="fa-solid fa-circle-exclamation text-bkg-red text-2xl"></i>
                <div>
                    <h2 class="text-bkg-red text-lg font-semibold">Alerta</h2>
                    <p>Hay un objeto muy cerca.</p>
                </div>
            </div>
            <button class="p-2" id="close_banner">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>

        <!-- Título centrado de la página -->

        <div class="p-6 items-center justify-between">
            <h1 class="py-2 font-semibold text-3xl">Monitoreo en Tiempo Real</h1>
            <p class="text-light">Monitorea la temperatura y la humedad en tiempo real</p>
        </div>

        <!-- Contenedor de tabla y gráfica -->
        <div class="p-6 grid grid-cols-1 md:grid-cols-2 h-full gap-8">
            <!-- Gráfica Temperatura -->
            <div class="bg-bkg-light rounded-2xl p-4">
                <canvas id="temperaturaChart" width="400" height="250"></canvas>
                <!-- Título y botón ver más -->
                <div class="flex items-center justify-between p-4">
                    <h2 class="text-lg font-semibold">Temperatura</h2>
                    <a th:href="@{/temperatura/}">
                        <button
                                class="bg-bkg-primary py-2 px-4 border-2 border-light-border rounded-xl w-fit h-fit">
                            <span>Ver más</span>
                            <i class="fa-solid fa-chevron-right"></i>
                        </button>
                    </a>
                </div>
            </div>

            <!-- Gráfica Humedad -->
            <div class="bg-bkg-light rounded-2xl p-4">
                <canvas id="humedadChart" width="400" height="250"></canvas>
                <!-- Título y botón ver más -->
                <div class="flex items-center justify-between p-4">
                    <h2 class="text-lg font-semibold">Humedad</h2>
                    <a th:href="@{/humedad/}">
                        <button
                                class="bg-bkg-primary py-2 px-4 border-2 border-light-border rounded-xl w-fit h-fit">
                            <span>Ver más</span>
                            <i class="fa-solid fa-chevron-right"></i>
                        </button>
                    </a>
                </div>
            </div>
        </div>
    </div>
    <footer>
        <script>
            const banner = document.getElementById("banner");
            const close_banner = document.getElementById("close_banner");

            const ctxHumedad = document.getElementById('humedadChart').getContext('2d');
            const chartHumedad = new Chart(ctxHumedad, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Humedad (%)',
                            data: [],
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        x: { title: { display: true, text: 'Tiempo' } },
                        y: { title: { display: true, text: 'Valores' }, beginAtZero: true }
                    }
                }
            });

            async function fetchHumedadData() {
                try {
                    const response = await fetch('/arduino/humedad/datos');
                    if (!response.ok) {
                        throw new Error('Error al obtener los datos');
                    }
                    const data = await response.json();
                    const tabla = document.getElementById('tabla-temperatura');
                    tabla.innerHTML = '';

                    data.forEach(d => {
                        const fila = `<tr>
                    <td>${d.id}</td>
                    <td>${d.humedad}</td>
                    <td>${d.fecha}</td>
                </tr>`;
                        tabla.innerHTML += fila;
                    });

                    const lastData = data[data.length - 1];
                    const now = new Date().toLocaleTimeString();
                    chartHumedad.data.labels.push(now);
                    chartHumedad.data.datasets[0].data.push(lastData.humedad);

                    if (chartHumedad.data.labels.length > 20) {
                        chartHumedad.data.labels.shift();
                        chartHumedad.data.datasets[0].data.shift();
                    }

                    chartHumedad.update();
                } catch (error) {
                    console.error('Error al obtener los datos:', error);
                }
            }

            fetchHumedadData();
            setInterval(fetchHumedadData, 5000);

            const ctxTemp = document.getElementById('temperaturaChart').getContext('2d');
            const chartTemp = new Chart(ctxTemp, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Temperatura (%)',
                            data: [],
                            borderColor: 'rgb(192,159,75)',
                            backgroundColor: 'rgba(192,151,75,0.2)',
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        x: { title: { display: true, text: 'Tiempo' } },
                        y: { title: { display: true, text: 'Valores' }, beginAtZero: true }
                    }
                }
            });

            async function fetchTemperaturaData() {
                try {
                    const response = await fetch('/arduino/temperatura/datos');
                    if (!response.ok) {
                        throw new Error('Error al obtener los datos');
                    }
                    const data = await response.json();
                    const tabla = document.getElementById('tabla-temperatura');
                    tabla.innerHTML = '';

                    data.forEach(d => {
                        const fila = `<tr>
                    <td>${d.id}</td>
                    <td>${d.temperatura}</td>
                    <td>${d.fecha}</td>
                </tr>`;
                        tabla.innerHTML += fila;
                    });

                    const lastData = data[data.length - 1];
                    const now = new Date().toLocaleTimeString();
                    chartTemp.data.labels.push(now);
                    chartTemp.data.datasets[0].data.push(lastData.temperatura);

                    if (chartTemp.data.labels.length > 20) {
                        chartTemp.data.labels.shift();
                        chartTemp.data.datasets[0].data.shift();
                    }

                    chartTemp.update();
                } catch (error) {
                    console.error('Error al obtener los datos:', error);
                }
            }

            fetchTemperaturaData();
            setInterval(fetchTemperaturaData, 5000);


            function remove_banner() {
                banner.classList.remove("flex");
                banner.classList.add("hidden");
            }

            close_banner.addEventListener("click", remove_banner);
        </script>
    </footer>
</div>
</body>

</html>